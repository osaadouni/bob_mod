"""
Create permission groups
Create permissions to models for a set of groups
"""
import logging

from django.core.management.base import BaseCommand
from django.contrib.auth.models import Group, User
from django.contrib.auth.models import Permission
from django.apps import apps
from django.contrib.contenttypes.models import ContentType
from django.db import IntegrityError


GROUPS = ['verbalisant', 'interceptie_desk']
MODELS = { 'resources': 'bobaanvraag'}
PERMISSIONS = [ 
    'aanmaken', 
    'indienen', 
    'behandelen', 
    'goedkeuren',
    'afkeuren',
    'verzenden_om',
    'annuleren',
]

GROUP_USERS = {
    'interceptie_desk': [
        'wouter', 'renate', 'admin'
    ]
}



class Command(BaseCommand):

    help = 'Creates read only default permissions for groups of users'

    def handle(self, *args, **options):
        for group in GROUPS:
            new_group , created = Group.objects.get_or_create(name=group)

            for app_label,model_name in MODELS.items():
                                    
                for permission in PERMISSIONS:
        
                    old_codename = 'can_{}_{}'.format(permission, model_name)
                    codename = 'can_{}'.format(permission)
                    name = 'Kan {} {}'.format(model_name, permission)
                    print("<< Deleting permission: {} -  {} / {}".format(name, codename, old_codename))

                    model = apps.get_model(app_label, model_name)
                    content_type = ContentType.objects.get_for_model(model)

                    Permission.objects.filter(content_type=content_type, codename__in=[codename, old_codename]).delete()

                    print(">> Creating permission: {} -  {}".format(codename, name))
                    model_add_perm = Permission.objects.create(codename=codename,
                                                               name=name,
                                                               content_type=content_type)
                    #continue

                    new_group.permissions.add(model_add_perm)

        print("Created default group and permissions")

        #for group_name, user_names in GROUP_USERS.items():
        #    group = Group.objects.get(name=group_name)
#
#            for username in user_names:
#                user = User.objects.get(username=username)
#                if user is None:
#                    email = '{}@test.com'.format(username)
#                    password = 'testme123'
#                    self.get_or_create(username, email, password)
#
#            users = [User.objects.get(username=un) for un in user_names]
            #group.user_set.set(users)

    def get_or_create(self, username, email, password, *args, **kwargs):
        try:
            new_user = User.objects.create_user(username, email, password)
        except IntegrityError:
            return User.objects.get(username=username)
        else:
            pass
        return new_user
